<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="memberMapper">
	
	<resultMap type="Member" id="memberResultset">
		<result column="user_no" property="userNo"/>
		<result column="user_id" property="userId"/>
		<result column="user_pwd" property="userPwd"/>
		<result column="user_name" property="userName"/>
		<result column="email" property="email"/>
		<result column="phone" property="phone"/>
		<result column="gender" property="gender"/>
		<result column="age" property="age"/>
		<result column="address" property="address"/>
		<result column="enroll_date" property="enrollDate"/>
		<result column="user_level" property="userLevel"/>
		<result column="pt" property="pt"/>
		<result column="qr" property="qr"/>
		<result column="profile_pic" property="profilePic"/>
		<result column="membership" property="membership"/>
		<!-- memberInfo -->
		<result column="height" property="height" />
		<result column="weight" property="weight" />
		<result column="disease" property="disease" />
		<result column="goal" property="goal" />
		<!-- bodyInfo -->
		<result column="body_info_no" property="bodyInfoNo" />
		<result column="measure_date" property="measureDate" />
		<result column="bmi" property="bmi" />
		<result column="fat" property="fat" />
		<result column="smm" property="smm" />
	</resultMap>
	
	<!-- member추가정보 -->
	<resultMap type="MemberInfo" id="memberInfoResultset">
		<result column="user_no" property="userNo"/>
		<result column="height" property="height"/>
		<result column="weight" property="weight"/>
		<result column="disease" property="disease"/>
		<result column="goal" property="goal"/>
	</resultMap>
	
	<!-- member신체정보 -->
	<resultMap type="BodyInfo" id="BodyInfoResultset">
		<result column="body_info_no" property="bodyInfoNo"/>
		<result column="user_id" property="userId"/>
		<result column="measure_date" property="measureDate"/>
		<result column="bmi" property="bmi"/>
		<result column="fat" property="fat"/>
		<result column="smm" property="smm"/>
	</resultMap>
	
	
	<select id="checkId" resultType="int">
		select count(user_id)
		  from member
		 where user_id = #{userId}
		   and status = 'Y'
	</select>

	<insert id="insertMember" parameterType="Member">
		INSERT 
		  INTO member 
		     ( user_no
		     , user_id
		     , user_pwd
		     , user_name
		     , email
		     , phone
		     , gender
		     , age
		     , address
		     , user_level
		     , profile_pic
		     , qr
		     )
        VALUES
        	 (
        	   seq_mno.nextval
        	 , #{userId}
        	 , #{userPwd}
        	 , #{userName}
        	 , #{email}
        	 , #{phone}
        	 , #{gender}
        	 , #{age}
        	 , #{address}
        	 , #{userLevel} 
        	 , #{profilePic}
        	 , 'qr_code_path'
        	 )
	</insert>
	
	<select id="selectUserNo" resultType="int">
	    SELECT seq_mno.currval 
	      FROM dual
	</select>
	
	<insert id="insertMemberInfo" parameterType="MemberInfo">
		INSERT 
		  INTO MEMBER_INFO
		     (
		       user_no
		     , height
		     , weight
		     , disease
		     , goal
		     )
		VALUES
		     (
		       #{userNo}
		     , #{height}
		     , #{weight}
		     , #{disease}
		     , #{goal}
		     )
	</insert>
	
	<select id="loginMember" resultMap="memberResultset">
		select user_no
		     , user_id
		     , user_pwd
		     , user_name
		     , email
		     , phone
		     , gender
		     , age
		     , address
		     , enroll_date
		     , user_level
		     , pt
		     , qr
		     , profile_pic
		     , membership
		  from member
		 where status = 'Y'
		   and user_id = #{userId}
	</select>
	
	<select id="getTrainee" resultMap="memberResultset">
		select * 
		  from member 
		 where pt = #{userId}
		   and user_level = 2
	</select>
	
	<select id="getTraineeList" resultMap="memberResultset">
		SELECT *
		  FROM MEMBER
		  JOIN BODY_INFO USING (USER_ID)
		  JOIN MEMBER_INFO USING (USER_NO)
		  WHERE (USER_ID, MEASURE_DATE) IN (
		      SELECT USER_ID, MAX(MEASURE_DATE)
		      FROM BODY_INFO
		      WHERE USER_ID IN (
		          SELECT USER_ID 
		            FROM MEMBER
		           WHERE PT = #{userId}
		      )
		      GROUP BY USER_ID
		  )
		  ORDER BY MEASURE_DATE DESC
	</select>
	
	<select id="getTraineeDetails" resultMap="memberResultset">
		SELECT * 
	    FROM MEMBER  
	    WHERE USER_ID = #{userId} 
	</select>
	
	<select id="getTraineeBodyInfo" resultMap="BodyInfoResultset">
		SELECT *
		  FROM BODY_INFO
		 WHERE USER_ID = #{userId}
	</select>
	
	<select id="getTraineeInfo" resultMap="memberInfoResultset">
		SELECT * 
		  FROM MEMBER_INFO
		 WHERE USER_NO = #{userNo}
	</select>

	
</mapper>
